<html>
<title>HTTP Benchmark Report Renderer</title>
<head>
    <!--Load the AJAX API-->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
      google.charts.load('current', {'packages': ['corechart']});

      google.charts.setOnLoadCallback(onLoadCallback);

      const exampleReport = ${report_json_data};
      function onLoadCallback() {
        drawChart(parseReport(exampleReport));
      }

      function onInputChange(files) {
        const selectedFile = files[0];
        selectedFile.text().then(text => JSON.parse(text)).then(parseReport).then(drawChart);
      }

      function onSelectChange(a) {
        console.log(a)
      }

      const percentiles = ["50.000%", "75.000%", "90.000%", "99.000%", "99.900%", "99.990%", "99.999%"];
      const regexs = {
        total: new RegExp(/^\s*(\d+) requests in/),
        error: new RegExp(/^\s*Non-2xx or 3xx responses: (\d+)\s*$$/),
        throughput: new RegExp(/^\s*Requests\/sec:\s*(.+)\s*$$/),
        percentile(name) {
          return new RegExp(`^\\s*$${name}\\s*(.+)\\s*$$`);
        }
      };

      function parseReport(report) {
        const data = {};
        for (const rate in report) {
          const stdout = report[rate];
          // console.log(stdout);
          const lines = stdout.split('\n');
          const item = data[rate] = {percentiles: {}, total: 0, error: 0, throughput: 0};
          percentiles.map(percentile => {
            lines.forEach(line => {
              const matches = regexs.percentile(percentile).exec(line);
              if (matches) {
                item.percentiles[percentile] = getMillis(matches[1].trim());
              }
            });
          });
          lines.forEach(line => {
            let matches = regexs.total.exec(line);
            if (matches) {
              item.total = Number(matches[1].trim());
            }
            matches = regexs.error.exec(line);
            if (matches) {
              item.error = Number(matches[1].trim());
            }
            matches = regexs.throughput.exec(line);
            if (matches) {
              item.throughput = Number(matches[1].trim());
            }
          });
        }
        return data;
      }

      // get milliseconds from string time representation
      function getMillis(str) {
        if (str.endsWith('ms')) {
          return Number(str.slice(0, -2))
        }

        if (str.endsWith('s')) {
          return Number(str.slice(0, -1)) * 1000
        }

        if (str.endsWith('m')) {
          return Number(str.slice(0, -1)) * 60 * 1000
        }

        throw new Error(`unhandled time unit $${str}`);
      }

      var latencyChart, latencyDataView;
      const latencyColumns = [{type: 'string', label: 'Percentiles'}];
      const rates = Object.keys(parseReport(exampleReport))
      rates.forEach(rate => {
            latencyColumns.push({
              type: 'number',
              label: rate,
              visible: true,
            })
      });
      var nullFunc = function() {return null;};

      const latencyDatas = [['Percentiles'].concat(rates)];
      for (const percentile of percentiles) {
        let row = [percentile];
        rates.forEach(rate => {
            let item = parseReport(exampleReport)[rate];
            row = row.concat(item.percentiles[percentile]);
        });
        latencyDatas.push(row);
      }
      console.log(latencyDatas);

      function drawChart(report) {
        console.log('draw chart for report', report);

        const throughputRows = [['Rate (Req/s)', 'Throughput']];
        const errRows = [['Rate (Req/s)', 'Error Rate']];

        for (const rate in report) {
          const item = report[rate];
          throughputRows.push([rate, item.throughput]);
          errRows.push([rate, (item.error / item.total) * 100]);
        }

        if (!latencyChart) {
          let latencyDataTable = new google.visualization.arrayToDataTable(latencyDatas);
          latencyDataView = new google.visualization.DataView(latencyDataTable);
          latencyChart = new google.visualization.LineChart(document.getElementById('latency'));

          google.visualization.events.addListener(latencyChart, 'click', function (target) {
            console.log("target", target);
            if (target.targetID.match(/^legendentry#\d+$$/)) {
              var index = parseInt(target.targetID.slice(12)) + 1;
              latencyColumns[index].visible = !latencyColumns[index].visible;
              drawChart(parseReport(exampleReport));
            }
          });
        }

        var visibleColumnIndexes = [0];
        //var colors = [];

        for (var i = 1; i < latencyColumns.length; i++) {
          if (latencyColumns[i].visible) {
            //colors.push(latencyColumns[i].color);

            visibleColumnIndexes.push(i);
          }
          else {
            //colors.push(latencyColumns[i].disabledColor);

            visibleColumnIndexes.push({
              calc: nullFunc,
              type: latencyColumns[i].type,
              label: latencyColumns[i].label,
            });
          }
        };
        latencyDataView.setColumns(visibleColumnIndexes);

        latencyChart.draw(latencyDataView, {
            title: 'Latency by Rate',
            // curveType: 'function',
            focusTarget: 'category',
            explorer: {
              actions: ['dragToZoom', 'rightClickToReset']
            },
            hAxis: {
              title: 'Percentiles',
            },
            vAxis: {
              title: 'Latency (ms)',
              viewWindow: {
                min: 0
              }
            }
            // width: 1500,
            // height: 600,
          }
        );


        /*new google.visualization.LineChart(document.getElementById('latency'))
          .draw(google.visualization.arrayToDataTable(latencyColumns), {
            title: 'Latency by Rate',
            // curveType: 'function',
            focusTarget: 'category',
            explorer: {
              actions: ['dragToZoom', 'rightClickToReset']
            },
            hAxis: {
              title: 'Percentiles',
            },
            vAxis: {
              title: 'Latency (ms)',
              viewWindow: {
                min: 0
              }
            }
            // width: 1500,
            // height: 600,
          });
        */

        new google.visualization.LineChart(document.getElementById('throughput'))
          .draw(google.visualization.arrayToDataTable(throughputRows), {
            title: 'Throughput by Rate',
            curveType: 'function',
            focusTarget: 'category',
            hAxis: {
              title: 'Rate (Req/s)',
            },
            vAxis: {
              title: 'Throughput (Req/s)',
              viewWindow: {
                min: 0
              }
            }
            // width: 1500,
            // height: 600,
          });

        new google.visualization.LineChart(document.getElementById('error-rate'))
          .draw(google.visualization.arrayToDataTable(errRows), {
            title: 'Error Rate by Rate',
            curveType: 'function',
            focusTarget: 'category',
            hAxis: {
              title: 'Rate (Req/s)',
            },
            vAxis: {
              title: 'Error Rate (%)',
              viewWindow: {
                min: 0,
                max: 100
              }
            }
            // width: 1500,
            // height: 600,
          });
      }
    </script>
</head>

<body>
<h1>HTTP Benchmark Report Renderer</h1>
<div>
    <label>Select file here to render</label> <input type="file" id="input" onchange="onInputChange(this.files)">
</div>
<!--<div>-->
<!--    <label>Graph Type</label>-->
<!--    <select onchange="onSelectChange(this)">-->
<!--        <option value="latency">Latency by Rate</option>-->
<!--        <option value="throughput">Throughput by Rate</option>-->
<!--        <option value="error-rate">Error Rate by Rate</option>-->
<!--    </select>-->
<!--</div>-->
<div id="latency" style="width: 100%; height: 600px"></div>
<div id="throughput" style="width: 100%; height: 600px"></div>
<div id="error-rate" style="width: 100%; height: 600px"></div>
</body>
</html>
